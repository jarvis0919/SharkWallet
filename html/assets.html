<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title></title>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <script src="../js/assets.js" charset="utf-8"></script>

</head>

<body>
    <div class="layui-layout layui-layout-admin">
        <div class="layui-header layui-bg-gray">
            <div class="layui-col-xs12">
                <div class="layui-col-xs11" style="-webkit-app-region: drag;font-size: 25px;">&nbsp;</div>
                <div class="layui-col-xs1 layui-col-space10">
                    <i class="layui-icon  layui-icon-subtraction layui-col-xs6"
                        style="font-size: 30px; color: #ffffff;font-weight:400;text-align:center"
                        onClick="minimizeindex()"></i>
                    <i class="layui-icon  layui-icon-close layui-col-xs6"
                        style="font-size: 30px; color: #ffffff;font-weight:400;text-align:center"
                        onClick="tocloseindex()"></i>
                </div>
            </div>
            <div class="layui-logo">SHARK</div>
            <ul class="layui-nav layui-layout-left">
                <li class="layui-nav-item layui-this"><a href="assets.html">资产</a></li>
                <li class="layui-nav-item"><a href="transaction.html">交易</a></li>
                <!-- <li class="layui-nav-item"><a href="dapp.html">DAPP</a></li> -->
                <li class="layui-nav-item"><a href="setup.html">设置</a></li>

            </ul>
            <form class="layui-form" action="">
                <div class="layui-form-item">
                    <div class="layui-inline layui-assets">
                        <div class="layui-input-inline layui-net">
                            <select name="selectnet" id="selectnet" lay-filter="selectnet">
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline layui-assets">
                        <div class="layui--inline layui-account">
                            <select name="selectaccount" id="selectaccount" lay-filter="selectaccount">
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- <div class="layui-nav-tree2"></div> -->
        <div class="layui-body2">
            <!-- <div class="layui-progress layui-progress-big layui-col-xs2" lay-showPercent="true">
                <div class="layui-progress-bar layui-bg-blue" lay-percent="80%"></div>
            </div> -->
            <div class="layui-row layui-col-xs12 layui-col-space15 assets">
                <div class="layui-col-xs6">
                    <div class="layui-card getbalance1">
                        <div class="layui-card-header">
                            <h2 class="layui-col-xs12">您账户的余额为：</h2>
                        </div>
                        <div class="layui-card-body getbalance">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6">
                    <div class="layui-panel getfenxi">
                        <div style="padding: 0px;">
                            <div class="layui-col-xs12">&nbsp;</div>
                            <div class="getfenxiaddress layui-col-xs12"
                                style="text-align: center; font-size: 20px;-moz-box-align: center;">
                            </div>
                            <div class="layui-col-xs12">
                                <div class="layui-col-xs4">&nbsp;</div>
                                <canvas class="layui-col-xs4" id="QRCode" style=""></canvas>
                                <div class="layui-col-xs4">&nbsp;</div>
                            </div>
                            <div class="layui-col-xs12" style="
                            text-align: center;
                            font-size: 19px;
                            font-weight: 300;">
                                <div>地址:</div>
                                <span id="addresscopyval" style="font-size: 18px;font-family: fantasy;"></span>
                            </div>
                            <div class="layui-col-xs12" style="font-size: 5px;">&nbsp;</div>
                            <div class="layui-col-xs12" id="addresscopy"
                                style="text-align: center; font-size: 15px;color: #ffffff;font-weight: bold;">
                                点击这里复制
                            </div>
                            <form name="" class="layui-col-xs12 layui-form" id="">
                                <div class="layui-col-xs12">&nbsp;</div>
                                <div class="layui-form-item layui-col-xs12">
                                    <div class="layui-col-xs3">&nbsp;</div>
                                    <div class="layui-input-block layui-col-xs6" style=" margin: 0;">
                                        <button type="button"
                                            class="layui-btn layui-btn-fluid layui-btn-radius getprivatekey" style="color: #6b7fff;
                                        background: #fff;
                                        font-weight: 600;
                                        font-size: 18px;
                                        box-shadow: 2px 2px 2px #cfcfcf;">导出私钥</button>
                                    </div>
                                    <div class="layui-col-xs3">&nbsp;</div>
                                </div>
                            </form>
                            <form class="layui-col-xs12 layui-form exportkey" style="display: none;" action="">
                                <div class="layui-col-xs12 exportaddress" id="" style="text-align: center;">&nbsp;</div>
                                <div class="layui-form-item layui-col-xs12 ">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">请输入您的密码:</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="" lay-verify="required" placeholder="请输入"
                                                autocomplete="off" class="layui-input" id="exportpass">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item layui-form-text layui-col-xs12 " id="getPrivatekeybox"
                                    style="display: none;">
                                    <label class="layui-form-label">您的私钥</label>
                                    <div class="layui-input-block">
                                        <textarea name="desc" placeholder="" class="layui-textarea" id="getPrivatekey"
                                            readonly></textarea>
                                    </div>
                                </div>
                                <div class="layui-form-item layui-col-xs12">
                                    <div class="layui-col-xs3">&nbsp;</div>
                                    <div class="layui-input-block layui-col-xs6 exportaccount" style="margin: 0;">
                                        <button class="layui-btn layui-btn-fluid layui-btn-radius " type="button" style="background: #6d7eff;
                                            font-weight: 600;
                                            font-size: 18px;
                                            box-shadow: 2px 2px 2px #cfcfcf;">导出私钥</button>
                                    </div>
                                    <div class="layui-col-xs3">&nbsp;</div>
                                </div>
                            </form>
                            <div class="toupdate"
                                style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;display: none;height: 40px;">
                                <div class="layui-col-xs12">下载进度</div>
                                <div class="layui-progress layui-progress-big layui-col-xs12" lay-showPercent="true"
                                    lay-filter="jingdutiao">
                                    <div class="layui-progress-bar layui-bg-blue " lay-percent="0%"></div>
                                </div>
                                <div class="layui-col-xs4">总大小：</div>
                                <div class="layui-col-xs8 updatesize"></div>
                            </div>
                            <div class="layui-col-xs12 " id="jingdutiao2" style="display:none">
                                <div class="layui-col-xs12" style="text-align: center;">下载进度</div>
                                <div class="layui-col-xs2">&nbsp;</div>
                                <div class="layui-progress layui-col-xs8" lay-filter="jingdutiao2">
                                    <div class="layui-progress-bar" lay-percent="0%"></div>
                                </div>
                                <div class="layui-col-xs2">&nbsp;</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-footer">
            <div class="layui-col-xs3" style="text-align: right;font-weight: bold;font-size: 18px;">当前操作账户为：&nbsp;&nbsp;&nbsp;</div>
            <h3 id="account" class="layui-col-xs2" style="padding-right: 10px; font-size: 18px; font-weight: bold;"></h3>
            <h3 id="address" class="layui-col-xs7" style="text-align: left; font-weight: bold;"></h3>
        </div>
    </div>



    <script src="./layui/layui.js"></script>
    <script>
        //JS 
        layui.use(['element', 'layer', 'util', 'form'], function () {
            var element = layui.element
                , layer = layui.layer
                , util = layui.util
                , form = layui.form
                , $ = layui.$;
            var QRCode = require('qrcode');
            const clipboard = require('electron').clipboard
            const userhome = require('userhome');
            const USE_HOME = userhome('AppData', 'Local', 'SharkWallet', 'Accountfile', 'json');
            //项目调试路径
            const accountpath = userhome(USE_HOME, 'account.json');
            const netpath = userhome(USE_HOME, 'net.json');
            const tokenlistpath = userhome(USE_HOME, 'tokenlist.json');
            const transactionpath = userhome(USE_HOME, 'transaction.json');
            const cookiepath = userhome(USE_HOME, 'cookie.json');
            let { ipcRenderer } = require('electron');
            ipcRenderer.on("balance", (event, symbol, balance) => {
                //console.log(symbol, balance);
                // $(".selecttoken1").attr("disabled","disabled");
                // $(".getbalance").empty();
                var p;

                if (balance == "查询失败") {
                    $("." + symbol + "").html("查询失败");
                    layer.msg('请检查节点是否连接正常或者网络是否通畅');
                } else {
                    $("." + symbol + "").html(balance)
                }
            })
            var update;
            var updatestate = false;
            var updatemax = false;
            ipcRenderer.on("checkUpdate", (event, updateAva, info) => {
                console.log(updateAva);
                console.log(info);
                if (updatestate == false) {
                    update = layer.open({
                        type: 1
                        , title: false //不显示标题栏
                        , closeBtn: false
                        , area: '300px;'
                        , shade: 0.8
                        , id: 'LAY_layuipro' //设定一个id，防止重复弹出
                        , btn: ['立即下载', '稍后更新']
                        , btnAlign: 'c'
                        , moveType: 1 //拖拽模式，0或者1
                        , content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">' + updateAva.msg + '<br>' + info.path + '<br>' + info.version + '<br>' + info.releaseDate + '<br></div>'
                        , success: function (layero) {
                            var btn = layero.find('.layui-layer-btn');
                            btn.find('.layui-layer-btn0').on('click', function () {
                                toupdate();
                                updatestate = true;
                            });
                        }
                    });
                }
            })
            ipcRenderer.on("message", (event, text) => {
                console.log(text);
            })
            ipcRenderer.on("Downloadstatus", (event, releaseNotes, releaseName, releaseDate, updateUrl, quitAndUpdate) => {
                console.log(releaseNotes + releaseName + releaseDate + updateUrl + quitAndUpdate);
            })
            ipcRenderer.on("downloadProgress", (event, releaseNotes) => {
                document.getElementById("jingdutiao2").style.display = "block";
                element.progress('jingdutiao', `${Math.ceil(releaseNotes.percent)}%`);
                $('.updatesize').html(((releaseNotes.total / 1024) / 1024).toFixed(2) + "MB")
                element.progress('jingdutiao2', `${Math.ceil(releaseNotes.percent)}%`);
            })
            function toupdate() {
                //layer.close(update);.update
                update = layer.open({
                    type: 1
                    , title: false //不显示标题栏
                    , closeBtn: false
                    , skin: 'update'
                    , area: ['500px', '200px']
                    , shade: 0.8
                    , id: 'download' //设定一个id，防止重复弹出
                    , btn: ['后台更新']
                    , btnAlign: 'c'
                    , moveType: 1 //拖拽模式，0或者1
                    , content: $('.toupdate')
                    , success: function (layero) {
                        ipcRenderer.send("updateApp");
                        var btn = layero.find('.layui-layer-btn');
                        btn.find('.layui-layer-btn0').on('click', function () {
                            document.getElementById("jingdutiao2").style.display = "block";
                        });
                    }
                });
            }
            form.on('select(selectaccount)', function (data) {
                //console.log(data)
                $("#address").text(data.value);
                $("#account").text(data.elem[data.elem.selectedIndex].text);
                $('.getfenxiaddress').text(data.elem[data.elem.selectedIndex].text);
                $("#addresscopyval").text(data.value);
                var net = $('#selectnet').val();
                var netid = $("#selectnet").val();
                getbalance(net, data.value, netid);
                Cookierefresh(net,data.value);
                //console.log(data.value); //得到被选中的值
                //console.log(data.elem[data.elem.selectedIndex].text); //得到文本内容
                //$("#Balanotice").text("余额刷新于：" + Date());
                var address = data.value.toString();
                var canvas = document.getElementById('QRCode')
                QRCode.toCanvas(canvas, address, function (error) {
                    if (error) console.error(error)
                    console.log('success!');
                })
                tokenlist();
            });
            form.on('select(selectnet)', function (data) {
                var address = $('#selectaccount').val();
                var netid = $("#selectnet").val();
                getbalance(data.value, address, netid);
                Cookierefresh(data.value,address);
                // console.log(data.othis); //得到美化后的DOM对象
                //console.log(data.value); //得到被选中的值
                //console.log(data.elem[data.elem.selectedIndex].text); //得到文本内容
                $("#Balanotice").text("余额刷新于：" + Date());
                tokenlist();
            });


            $.ajax({
                url: accountpath,
                dataType: 'json',
                type: 'get',
                success: function (data) {
                    $.ajax({
                        url: cookiepath,
                        dataType: 'json',
                        type: 'get',
                        success: function (cookie) {
                            console.log(cookie);
                            var key = 0;
                            $.each(data.data, function (index, value) {
                                console.log(key)
                                $('#selectaccount').append(new Option(value.id, value.address));// 下拉菜单里添加元素
                                if (cookie.account == value.address) {
                                    document.getElementById("selectaccount")[key].selected = true;
                                    console.log("cookie is null");
                                }
                                key++;
                                console.log(key)
                            });
                            var batch = $('#selectaccount').val();
                            $("#account").text($("#selectaccount option:selected").text());
                            $("#address").text(batch);
                            layui.form.render("select");

                        }
                    })
                }
            })
            $.ajax({
                url: netpath,
                dataType: 'json',
                type: 'get',
                success: function (data) {
                    $.ajax({
                        url: cookiepath,
                        dataType: 'json',
                        type: 'get',
                        success: function (cookie) {
                            console.log(cookie);
                            var key = 0;
                            $.each(data.data, function (index, value) {
                                console.log(key)
                                $('#selectnet').append(new Option(value.id, value.net));
                                if (cookie.net == value.net) {
                                    document.getElementById("selectnet")[key].selected = true;
                                }
                                key++;
                                console.log(key)
                            });
                            
                            layui.form.render("select");

                        }
                    })
                }
            })
            setTimeout(() => { tokenlist() }, 500);
            function tokenlist() {
                $.ajax({
                    url: tokenlistpath,
                    dataType: 'json',
                    type: 'get',
                    success: function (data) {
                        //console.log(data);
                        $(".getbalance").empty();
                        // $(".getbalance").empty();
                        //下面会提到这个data是什么值
                        //使用循环遍历，给下拉列表赋值
                        var p;
                        var address = $('#selectaccount').val();
                        //console.log(data[address]);
                        var k = [];
                        //console.log(k);
                        // setTimeout(() => { tableIn2.reload(); }, 500);
                        //console.log("nmb===>" + $("#selectnet").val())
                        for (var key in data[address]) {
                            // console.log(key);
                            // console.log(data[address]);
                            // console.log(data[address][key].net);
                            if (data[address][key].net == $("#selectnet").val()) {
                                //console.log("这里")
                                k.push(data[address][key]);
                                //console.log(k);
                            } else if (data[address][key].address == "ETH") {
                                //console.log("这里")
                                k.push(data[address][key]);
                                //console.log(k);
                            }
                        }
                        for (var key in k) {
                            //console.log("symbol" + k[key].symbol)
                            symbol = k[key].symbol;
                            address = k[key].address;
                            Company = k[key].Company;
                            if (symbol == "ETH") {
                                $(".getbalance").empty();
                                a = '<div class="layui-col-xs12 " style="padding: 10px 0px 0px 0px;top:0;left:0;" ><div class="layui-panel getbalancepanel"style=""><div style="padding: 15px"><img src="../img/ETH.png" class="layui-nav-img layui-col-xs3 imgbalance"><div class="layui-col-xs9"><div class=" layui-col-xs12"style="font-size: 20px;padding:7px 0px 0px 0px;"><div class="layui-col-xs6">' + symbol + '</div><div class="' + symbol + ' symbolstyle layui-col-xs5" style="font-size: 18px;text-align: center;"></div><div class = "layui-col-xs1" style="font-size: 15px;">' + Company + '</div></div></div></div></div>';
                                $(".getbalance").prepend(a);
                            } else {
                                a = '<div class="layui-col-xs12 " style="padding: 10px 0px 0px 0px;top:0;left:0;"><div class="layui-panel getbalancepanel" style=""><div style="padding: 15px"><img src="../img/ETH.png" class="layui-nav-img layui-col-xs3 imgbalance"><div class="layui-col-xs9"><div class="layui-col-xs12" style="font-size: 20px;padding:7px 0px 0px 0px;"><div class="layui-col-xs6" >' + symbol + '</div><div class="' + symbol + ' symbolstyle layui-col-xs5" style="font-size: 18px;text-align: center;"></div><div class = "layui-col-xs1" style="font-size: 15px;">' + Company + '</div></div></div></div></div>';
                                $(".getbalance").append(a);
                            }
                        }
                        //console.log("nogood")
                        //console.log($("#selectnet option:selected").text())
                        var netid = $("#selectnet").val();
                        getbalance($('#selectnet').val(), $('#selectaccount').val(), netid);
                    }
                })
            }
            setTimeout(() => {
                var options = $("#selectaccount option:selected");
                $('.getfenxiaddress').text(options.text());
                $("#addresscopyval").text(options.val());
                var address = options.val();
                var canvas = document.getElementById('QRCode')
                QRCode.toCanvas(canvas, address, function (error) {
                    if (error) console.error(error)
                    //console.log('success!');
                })
            }, 1000);
            //setTimeout(() => { $("#Balanotice").text("余额刷新于：" + Date()); }, 1500);
            $('.exportaccount').on('click', function () {
                exportaccount($('.exportaddress').html(), $('#exportpass').val());
            });
            $('.getprivatekey').on('click', function () {
                $('.exportaddress').html($('#addresscopyval').text());
                importshowaccount = layer.open({
                    type: 1
                    , title: "导出私钥"
                    , content: $('.exportkey')//$('.shownet').style.display = "block"
                    , area: ['350px', '350px']
                    , offset: 'auto' //右上角
                    , anim: 5
                    //, shade:
                    , resize: false
                    , cancel: function (index, layero) {
                        // exportaddress addresscopyval
                        $('#id').val(null);
                        $('#exportpass').val(null)
                        $('#getPrivatekey').val(null);
                        $('#getPrivatekey').val(null);
                        $('#getPrivatekeybox').css("display", "none");
                    }
                });
            })
            var code = document.querySelector("#addresscopy");
            // const copyInput = document.getElementById('copy-to-input')
            code.onclick = function () {
                clipboard.writeText(document.querySelector("#addresscopyval").innerHTML);
                document.querySelector("#addresscopy").innerHTML = "复制成功";
                setTimeout(() => { document.querySelector("#addresscopy").innerHTML = "点击这里复制"; }, 2000);
            };


            util.event('lay-header-event', {
                //左侧菜单事件
                menuLeft: function (othis) {
                    layer.msg('展开左侧菜单的操作', { icon: 0 });
                }
                , menuRight: function () {
                    layer.open({
                        type: 1
                        , content: '<div style="padding: 15px;">处理右侧面板的操作</div>'
                        , area: ['260px', '100%']
                        , offset: 'rt' //右上角
                        , anim: 5
                        , shadeClose: true
                    });
                }
            });

        });
    </script>
</body>

</html>